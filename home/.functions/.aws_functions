alias awsacctalias="aws iam list-account-aliases | jq -r \".AccountAliases[0]\""
alias awsgetcaller="aws sts get-caller-identity"
alias awsgetacct="aws sts get-caller-identity --query 'Account' --output text"
alias awsunsetcreds="unset AWS_SHARED_CREDENTIALS_FILE"
alias awscheckcreds="printenv | grep AWS_SHARED_CREDENTIALS_FILE"
alias awsunsetprofile="unset AWS_PROFILE"
alias awscheckprofile="printenv | grep AWS_PROFILE"
alias awscheck="printenv | grep AWS_"
alias awswhoami="aws iam list-account-aliases | jq -r \".AccountAliases[0]\";aws sts get-caller-identity"



function awscmd {
  local AWCCLI_COMMAND
  local AWCCLI_RESPONSE="$($AWCCLI_COMMAND 2>&1 || true)"
  if [[ "$AWCCLI_RESPONSE" == *'An error occurred'* ]]; then
    log "ERROR: $AWCCLI_RESPONSE"
    exit 1
  else
    echo "Implement me to pass a call but wrap with exception handling!!"
    log "$AWCCLI_RESPONSE"
  fi
}




function awssetcreds {
    export AWS_SHARED_CREDENTIALS_FILE="$1"
}

function awssetprofile {
    export AWS_PROFILE="$1"
}

function awssetregion {
    export AWS_REGION="$1"
}

function awsunset {
  #https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html
  unset AWS_ACCESS_KEY_ID
  unset AWS_SECRET_ACCESS_KEY
  unset AWS_SESSION_TOKEN
  unset AWS_DEFAULT_REGION
  unset AWS_DEFAULT_OUTPUT
  unset AWS_DEFAULT_PROFILE
  unset AWS_CA_BUNDLE
  unset AWS_SHARED_CREDENTIALS_FILE
  unset AWS_CONFIG_FILE
  #https://docs.aws.amazon.com/cli/latest/topic/config-vars.html
  unset AWS_PROFILE
  unset AWS_METADATA_SERVICE_TIMEOUT
  unset AWS_METADATA_SERVICE_NUM_ATTEMPTS
  #I think this is remanant of usage thart was supposed to be looking at AWS_DEFAULT_REGION yet here it lives on :(
  unset AWS_REGION
}

#Install SSM Manager plugin
# Reference: https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html
# curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip" -o "sessionmanager-bundle.zip"
# unzip sessionmanager-bundle.zip
# sudo ./sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin
# #Output should match: "The Session Manager plugin is installed successfully. Use the AWS CLI to start a session."
# session-manager-plugin
function awsssmto {
  local sts_output=$(aws sts get-caller-identity | jq -r '.Arn')
  echo "Using AWS Credentials: $sts_output"
  echo " "
  echo "Searching for instancewith '$1' in the name..."
  # local target="$(aws ec2 describe-instances --filters "Name=tag:Name,Values=*$1*" --region "$AWS_REGION")"
  local target="$(aws ec2 describe-instances --filters "Name=tag:Name,Values=*$1*")"
  local target_name="$(echo $target| jq -r '.Reservations[0].Instances[]|.Tags[]|select(.Key=="Name")|.Value')"
  target_id="$(echo $target| jq -r '.Reservations[0].Instances[]|.InstanceId')"
  echo "Connection to instance via ssm: [$target_name] - [$target_id]"
  # aws ssm start-session --target "$target_id" --region "$AWS_REGION"
  aws ssm start-session --target "$target_id"
}

function awsssminventory {
  echo "============================================================"
  local sts_output=$(aws sts get-caller-identity | jq -r '.Arn')
  echo "Using AWS Credentials: $sts_output"
  echo " "
  echo "Show SSM Ec2 Instance Inventory:"
  echo " "
  local result_size="100"

  # NOTE: Here we want to use the pagination api and build the full list before moving on to gettign the ec2 information

  # local instance_ids=($(aws ssm get-inventory | jq -r '.Entities[] | .Data | ."AWS:InstanceInformation" | .Content[] | select(.InstanceStatus!="Terminated") | .InstanceId'))
  local instance_ids=($(aws ssm get-inventory | jq -r '.Entities[] | .Data | ."AWS:InstanceInformation" | .Content[] | select(.InstanceStatus!="Terminated") | "\(.InstanceId)|\(.IpAddress)"'))
  # local instance_ids=($(aws ssm get-inventory --max-items "$result_size" --page-size" $result_size" | jq -r '.Entities[] | .Data | ."AWS:InstanceInformation" | .Content[] | select(.InstanceStatus!="Terminated") | .InstanceId'))

  local instance_ids_spaced_list=''
  for id in ${instance_ids[@]}
  do
    echo "${id}"
    instance_ids_spaced_list="$instance_ids_spaced_list${id%[|]*} "
  done
  # local describe_output="$(aws ec2 describe-instances --instance-ids $instance_ids_spaced_list)"
  local describe_output="$(aws ec2 describe-instances  --instance-ids $instance_ids_spaced_list --query 'Reservations[*].Instances[*].[InstanceId,ImageId,PrivateIpAddress,Tags[?Key==`Name`].Value]')"
  # echo "$describe_output" | jq -r '.Reservations[] | .Instances[] | .Tags[] | select(.Key=="Name") | .Value'
  # echo "$describe_output" | jq -r '.Reservations[] | .Instances[] | select(.Tags[].Key=="Name") | "\( select(.Tags[] | .Key=="Name" ).Value)|\(.InstanceId)|\(.PrivateIpAddress)|\(.PrivateIpAddress)"'
  # echo "$describe_output" | jq -r '.Reservations[] | .Instances[] | select(.Tags[].Key=="Name") | select(.Tags[].Key | contains("Name")) | .Value'
  # echo "$describe_output" | jq -r '.Reservations[] | .Instances[] | select(.Tags[].Key=="Name") | select(.Tags[].Key | contains("Name"))'

  # echo "$describe_output"
  echo "$describe_output" |  jq -r '.[] | .[] | "\(.[0])|\(.[1])|\(.[2])|\(.[3]|.[0])"'

  echo "============================================================"
}

function awsgetinstancedata {
  aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,ImageId,Tags[?Key==`Name`].Value]' | jq -r '.[] | .[] | "\(.[0])|\(.[1])|\(.[2]|.[0])"' | grep $1
}

function awsacctnumberfromarn {
  if [ "" != "$1" ]; then
    echo "$1" | awk -F':' '{print $5}'
  fi
}

function awshelp {

MESSAGE=`cat <<HEREDOC_MESSAGE
Aliases:
  awsacctalias
  awsgetcaller
  awsunsetcreds
  awscheckcreds
  awsunsetprofile
  awscheckprofile
  awscheck
  awswhoami

Functions:
  awssetcreds
  awssetprofile
  awssetregion
  awsunset
  awsssmto
  awsssminventory
  awsgetinstancedata
  awsacctnumberfromarn

HEREDOC_MESSAGE
`
echo "$MESSAGE"
}

function awsref {

MESSAGE=`cat <<HEREDOC_MESSAGE

  Training and Certification:
   - https://pages.awscloud.com/AWS-Traincert_Ramp-up_Guides.html


HEREDOC_MESSAGE
`
echo "$MESSAGE"
}
